<?xml version="1.0" encoding="UTF-8"?>
<project basedir=".">
    <taskdef resource="net/sf/antcontrib/antcontrib.properties">
        <classpath>
            <pathelement location="lib/ant-contrib-1.0b3.jar"/>
        </classpath>
    </taskdef>
    <property file="${basedir}/properties/${env}/deploy.properties"/>
    <condition property="script.interpreter" value="bash" else="cmd">
        <os family="unix"/>
    </condition>
    <condition property="script.switch" value="/c" else="">
        <not>
            <os family="unix"/>
        </not>
    </condition>
	<condition property="script.background" value="&amp;" else="">
        <os family="unix"/>
    </condition>
    <condition property="script.suffix" value="sh" else="bat">
        <os family="unix"/>
    </condition>
    <tstamp>
        <format property="cctimestamp" pattern="yyyy-MM-dd HH:mm:ss"/>
    </tstamp>

    <target name="copy.national.to.tomcat">
        <echo message="Deploying to tomcat at ${tomcat.url} with tomcat home ${tomcat.home}"/>
        <delete dir="${tomcat.home}/webapps/${app.name}"/>
        <copy file="${download.dir}/${app.name}.war" tofile="${tomcat.home}/webapps/${app.name}.war" overwrite="true"/>
        <delete dir="${tomcat.home}/work/Catalina/localhost/${app.name}"/>
    </target>

    <target name="copy.local.war">
	<echo message="Deploying to tomcat at ${tomcat.url} with tomcat home ${tomcat.home}"/>
        <delete dir="${tomcat.home}/webapps/${app.name}"/>
        <copy file="${download.dir}/${local.war.file}" tofile="${tomcat.home}/webapps/${app.name}.war" overwrite="true"/>
        <delete dir="${tomcat.home}/work/Catalina/localhost/${app.name}"/>
    </target>

    <target name="start.tomcat">
        <echo message="Starting tomcat..."/>
        <echo message="Waiting for tomcat to start on ${tomcat.url}"/>
        <exec executable="${script.interpreter}" dir="${tomcat.home}" spawn="true">
            <arg line="${script.switch} ${tomcat.home}/bin/startup.${script.suffix}"/>
        </exec>
        <waitfor checkevery="500" checkeveryunit="millisecond" maxwait="15" maxwaitunit="minute"
                 timeoutproperty="tomcat.timeout">
            <http url="${tomcat.url}"/>
        </waitfor>
        <fail if="tomcat.timeout" message="Error starting up tomcat..."/>
        <echo message="tomcat started"/>
    </target>
    <target name="stop.tomcat" description="stop tomcat">
        <echo message="Stopping tomcat..."/>
        <echo message="Waiting for tomcat to stop on ${tomcat.url}"/>
        <exec executable="${script.interpreter}" dir="${tomcat.home}" spawn="true">
            <arg line="${script.switch} ${tomcat.home}/bin/shutdown.${script.suffix}"/>
        </exec>
        <waitfor checkevery="100" checkeveryunit="millisecond" maxwait="2" maxwaitunit="minute"
                 timeoutproperty="tomcat.timeout">
            <not>
                <http url="${tomcat.url}"/>
            </not>
        </waitfor>
        <fail if="tomcat.timeout" message="Error shutting down tomcat..."/>
        <echo message="tomcat stopped"/>
    </target>
    
    <target name="restart.tomcat" description="restart tomcat">
        <echo message="restarting tomcat..."/>
        <exec executable="${script.interpreter}" dir="${tomcat.home}" spawn="true">
            <arg line="${script.switch} ${tomcat.home}/bin/shutdown.${script.suffix}"/>
        </exec>
        <waitfor checkevery="100" checkeveryunit="millisecond" maxwait="2" maxwaitunit="minute" timeoutproperty="tomcat.timeout">
            <not>
                <http url="${tomcat.url}"/>
            </not>
        </waitfor>
        <fail if="tomcat.timeout" message="Error shutting down tomcat..."/>
        <exec executable="${script.interpreter}" dir="${tomcat.home}" spawn="true">
            <arg line="${script.switch} ${tomcat.home}/bin/startup.${script.suffix} ${script.background}"/>
        </exec>
        <waitfor checkevery="100" checkeveryunit="millisecond" maxwait="2" maxwaitunit="minute" timeoutproperty="tomcat.timeout">
            <http url="${tomcat.url}"/>
        </waitfor>
        <fail if="tomcat.timeout" message="Error starting up tomcat..."/>
        <echo message="tomcat restarted"/>
    </target>
    
    <target name="clean.tomcat.logs" depends="stop.tomcat" description="Nuke all tomcat logs">
        <delete failonerror="false">
            <fileset dir="${tomcat.home}/logs" includes="*"/>
        </delete>
        <echo message="removed tomcat logs"/>
    </target>
	<path id="tomcat.classpath">
	<fileset dir="${basedir}/lib/tomcat/">
	  <include name="*.jar"/>
	  </fileset>
	</path>

  <!-- Configure the custom Ant tasks for the Manager application -->
  <taskdef name="deploy"    classname="org.apache.catalina.ant.DeployTask" classpathref="tomcat.classpath"/>
  <taskdef name="list"      classname="org.apache.catalina.ant.ListTask" classpathref="tomcat.classpath"/>
  <taskdef name="reload"    classname="org.apache.catalina.ant.ReloadTask" classpathref="tomcat.classpath"/>
  <taskdef name="findleaks" classname="org.apache.catalina.ant.FindLeaksTask" classpathref="tomcat.classpath"/>
  <taskdef name="resources" classname="org.apache.catalina.ant.ResourcesTask" classpathref="tomcat.classpath"/>
  <taskdef name="start"     classname="org.apache.catalina.ant.StartTask" classpathref="tomcat.classpath"/>
  <taskdef name="stop"      classname="org.apache.catalina.ant.StopTask" classpathref="tomcat.classpath"/>
  <taskdef name="undeploy"  classname="org.apache.catalina.ant.UndeployTask" classpathref="tomcat.classpath"/>

  <target name="deploy" description="Install">
    <deploy url="${tomcat.qa.manager.url}" username="${tomcat.user}" password="${tomcat.password}" path="/${app.name}" war="file:${download.dir}/${app.name}.war"/>
  </target>

  <target name="reload" description="Reload">
    <reload url="${tomcat.qa.manager.url}" username="${tomcat.user}" password="${tomcat.password}" path="/${app.name}"/>
  </target>

  <target name="stop" description="Stop">
    <stop url="${tomcat.qa.manager.url}" failonerror="false" username="${tomcat.user}" password="${tomcat.password}" path="/${app.name}"/>
  </target>

  <target name="start" description="Start">
    <start url="${tomcat.qa.manager.url}" username="${tomcat.user}" password="${tomcat.password}" path="/${app.name}"/>
  </target>
  
  <target name="undeploy" description="Remove">
    <undeploy url="${tomcat.qa.manager.url}"  failonerror="false" username="${tomcat.user}" password="${tomcat.password}" path="/${app.name}"/>
  </target> 	
</project>
